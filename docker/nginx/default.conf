# the upstream component nginx needs to connect to
upstream django {
     server unix:///app/tr_art/tr_art/art.sock; # for a file socket
    #server 127.0.0.1:81; # for a web port socket (we'll use this first)
}

# configuration of the server

    limit_req_zone $binary_remote_addr zone=one:10m rate=2r/s;
server {
    # the port your site will be served on
    listen      80;
    # the domain name it will serve for
    server_name 127.0.0.1; # substitute your machine's IP address or FQDN
    charset     utf-8;
    server_tokens off;
    # max upload size
    client_max_body_size 75M;   # adjust to taste

    # SSL

    #listen 443 ssl spdy;
    #listen [::]:443 ssl spdy;
    #ssl_certificate /etc/letsencrypt/live/kurasgrechey.ru/fullchain.pem;
    #ssl_certificate_key /etc/letsencrypt/live/kurasgrechey.ru/privkey.pem;
    #ssl_session_timeout 1d;
    #ssl_session_cache shared:SSL:10m;

    #ssl_protocols TLSv1.1 TLSv1.2;
    #ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK';
    #ssl_prefer_server_ciphers on;

    add_header Strict-Transport-Security max-age=15768000;

    ssl_stapling on;
    ssl_stapling_verify on;

## verify chain of trust of OCSP response using Root CA and Intermediate certs
    ssl_trusted_certificate /etc/letsencrypt/live/kurasgrechey.ru/chain.pem;
    resolver 8.8.8.8 8.8.4.4 valid=86400;
    resolver_timeout 10;

    # SSL end

    # Django media
    #location /media  {
    #    alias /path/to/your/mysite/media;  # your Django project's media files - amend as required
    #}

    location /static {
        alias /app/tr_art/static; # your Django project's static files - amend as required
    }

    # Finally, send all non-media requests to the Django server.
    location / {
        limit_req zone=one burst=3;
        uwsgi_pass  django;
        include     /app/tr_art/tr_art/uwsgi_params; # the uwsgi_params file you installed
        if ($http_host ~ "^www\.kurasgrechey\.ru$"){
            rewrite ^(.*)$ http://kurasgrechey.ru/$1 redirect;
        }
        if ($http_host ~ "^85\.143\.223\.55"){
            rewrite ^(.*)$ http://kurasgrechey.ru/$1 redirect;
        }
        if ($http_user_agent ~ "libwww-perl.*"){
            return 403;
        }
    }
#    error_page 400 404 /404.html;
#    location = /404.html {
#        root /app/static/;
#        internal;
#    }
#    error_page 500 502 503 504 /50x.html;
#    location = /50x.html {
#        root /app/static/;
#        internal;
#    }
}